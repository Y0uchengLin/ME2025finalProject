<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>Parkour Game - Menu</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body style="background-color: #333;">

  <div class="menu-container" id="main_menu_container">

    <h1>ğŸƒâ€â™‚ï¸ è·‘é…·éŠæˆ² ğŸ¯</h1>

    <div id="auth_panel">
      <h3>ç™»å…¥ / è¨»å†Š</h3>
      <input id="auth_username" placeholder="Username">
      <input id="auth_password" type="password" placeholder="Password">
      <div>
        <button id="btn_login">ç™»å…¥</button>
        <button id="btn_register">è¨»å†Š</button>
        <button id="btn_logout" style="display:none;">ç™»å‡º</button>
      </div>
    </div>

    <div id="mode_panel" style="display:none;">
      <h3>é¸æ“‡éŠæˆ²æ¨¡å¼</h3>
      <p id="welcome_message" style="color: lightgreen;"></p>
      <button onclick="startGame('height')">â›°ï¸ ç™»é«˜æ¨¡å¼ (é«˜åº¦)</button>
      <button onclick="startGame('speed')">â±ï¸ é€Ÿåº¦ç«¶è³½ (æ™‚é–“)</button>
      <button id="btn_show_leaderboard">ğŸ† æŸ¥çœ‹æ’è¡Œæ¦œ</button>
      <button id="btn_logout_mode_panel">ç™»å‡º</button>
    </div>

    <div id="leaderboard_panel" class="menu-container" style="display:none;">
        <h3>ğŸ† æ’è¡Œæ¦œ</h3>
        <button id="btn_toggle_leaderboard_mode">åˆ‡æ›è‡³ é€Ÿåº¦/ç™»é«˜ æ’è¡Œæ¦œ</button>
        <div id="leaderboard_content"></div>
        <button onclick="hideLeaderboard()">è¿”å›ä¸»é¸å–®</button>
    </div>
  </div>

  <script>
    const authPanel = document.getElementById("auth_panel");
    const modePanel = document.getElementById("mode_panel");
    const leaderboardPanel = document.getElementById("leaderboard_panel");
    const leaderboardContent = document.getElementById("leaderboard_content");
    const btnLogoutAuth = document.getElementById("btn_logout");
    const btnLogoutMode = document.getElementById("btn_logout_mode_panel");

    let currentLeaderboardMode = 'height'; 

    function showModePanel(username) {
        document.getElementById("welcome_message").innerText = `æ­¡è¿å›ä¾†, ${username}!`;
        authPanel.style.display = 'none';
        modePanel.style.display = 'flex';
        btnLogoutAuth.style.display = 'none';
    }

    function showAuthPanel() {
        authPanel.style.display = 'flex';
        modePanel.style.display = 'none';
        leaderboardPanel.style.display = 'none';
        btnLogoutAuth.style.display = 'none'; // ç™»å…¥å‰ä¸é¡¯ç¤ºç™»å‡º
    }
    
    // ç™»å…¥
    document.getElementById("btn_login").onclick = () => {
      const username = document.getElementById("auth_username").value;
      const password = document.getElementById("auth_password").value;

      fetch("/api/login", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        credentials: "include",
        body: JSON.stringify({ username, password })
      }).then(r => r.json()).then(res => {
        if(res.error) return alert("ç™»å…¥å¤±æ•—: " + res.error);
        showModePanel(res.username);
      });
    };

    // è¨»å†Š
    document.getElementById("btn_register").onclick = () => {
      const username = document.getElementById("auth_username").value;
      const password = document.getElementById("auth_password").value;

      fetch("/api/register", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        credentials: "include",
        body: JSON.stringify({ username, password })
      }).then(r => r.json()).then(res => {
        if(res.error) return alert("è¨»å†Šå¤±æ•—: " + res.error);
        alert("è¨»å†ŠæˆåŠŸï¼Œè«‹ç™»å…¥");
      });
    };
    
    // ç™»å‡º
    function logout() {
        fetch("/api/logout", { method: "POST" })
            .then(() => {
                alert("å·²ç™»å‡º");
                showAuthPanel();
            })
            .catch(e => console.error("Logout error:", e));
    }
    btnLogoutAuth.onclick = logout;
    btnLogoutMode.onclick = logout;

    // é–‹å§‹éŠæˆ²
    function startGame(mode){
      window.location.href = `/game/${mode}`;
    }

    // æª¢æŸ¥ç™»å…¥ç‹€æ…‹ (é é¢è¼‰å…¥æ™‚)
    window.onload = () => {
        fetch("/api/login", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            credentials: "include",
            body: JSON.stringify({ "check_session": true })
        }).then(r => {
            if (r.ok) return r.json();
            throw new Error('Not logged in');
        }).then(res => {
            if (res.username) showModePanel(res.username);
        }).catch(e => {
            showAuthPanel();
        });
    }

    // é¡¯ç¤ºæ’è¡Œæ¦œ
    document.getElementById("btn_show_leaderboard").onclick = () => {
        modePanel.style.display = 'none';
        leaderboardPanel.style.display = 'flex';
        fetchLeaderboard(currentLeaderboardMode);
    };

    // åˆ‡æ›æ’è¡Œæ¦œæ¨¡å¼
    document.getElementById("btn_toggle_leaderboard_mode").onclick = () => {
        currentLeaderboardMode = currentLeaderboardMode === 'height' ? 'speed' : 'height';
        fetchLeaderboard(currentLeaderboardMode);
    };

    // ç²å–ä¸¦æ¸²æŸ“æ’è¡Œæ¦œ
    function fetchLeaderboard(mode) {
        leaderboardContent.innerHTML = '<p>è¼‰å…¥ä¸­...</p>';
        const url = mode === 'height' ? "/api/leaderboard_height" : "/api/leaderboard_speed";
        
        document.getElementById("btn_toggle_leaderboard_mode").innerText = 
            mode === 'height' ? 'åˆ‡æ›è‡³ â±ï¸ é€Ÿåº¦ç«¶è³½ æ’è¡Œæ¦œ' : 'åˆ‡æ›è‡³ â›°ï¸ ç™»é«˜æ¨¡å¼ æ’è¡Œæ¦œ';

        fetch(url)
            .then(r => r.json())
            .then(data => {
                let html = `<table><tr><th>#</th><th>ç©å®¶</th><th>${mode === 'height' ? 'æœ€é«˜é«˜åº¦ (m)' : 'æœ€å¿«æ™‚é–“ (s)'}</th></tr>`;
                
                data.forEach((item, index) => {
                    // é€Ÿåº¦æ¨¡å¼çš„ time æ˜¯ int (ç™¾åˆ†ä¹‹ä¸€ç§’)ï¼Œæ‰€ä»¥è¦é™¤ä»¥ 100
                    const score = mode === 'height' ? item.height : (item.time / 100).toFixed(2);
                    html += `<tr><td>${index + 1}</td><td>${item.name}</td><td>${score}</td></tr>`;
                });

                html += '</table>';
                leaderboardContent.innerHTML = html;
            })
            .catch(error => {
                leaderboardContent.innerHTML = '<p style="color: red;">è¼‰å…¥æ’è¡Œæ¦œå¤±æ•—ã€‚</p>';
                console.error('Error fetching leaderboard:', error);
            });
    }

    // éš±è—æ’è¡Œæ¦œ
    function hideLeaderboard() {
        leaderboardPanel.style.display = 'none';
        modePanel.style.display = 'flex';
    }
  </script>

</body>
</html>